<!--
  Copyright (C) 2018 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<xf:model
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:saxon="http://saxon.sf.net/"
    xmlns:frf="java:org.orbeon.oxf.fr.FormRunner"
    xmlns:frp="java:org.orbeon.oxf.fr.FormRunnerPersistenceJava"

    id="fr-versioning-model"
    xxf:xpath-analysis="true">

    <xf:var name="app"  value="fr:app-name()"/>
    <xf:var name="form" value="fr:form-name()"/>

    <xf:var
        name="versioning-supported-on-data-side"
        value="xxf:non-blank($app) and frf:versioningSupported($app, $form)"/>

    <!--
        Usage:

        <xf:dispatch name="fr-read-versions" targetid="fr-versioning-model">
            <xf:property name="restrict-to-latest-version" value="false()"/>
        </xf:dispatch>

        - `restrict-to-latest-version as xs:boolean?`
            - default: `false()`
            - whether to load only the latest version or all versions

        Dispatches `fr-versions-read` upon success, with:

        - `versions as xs:integer+*`:
            - all available versions
        - `latest-version as xs:integer`
            - the latest version number
        - `default-selected-version as xs:integer?`
            - non-empty if there is only one version available

        Sends a 404 if no form metadata was found.
    -->
    <xf:action event="fr-read-versions">

        <xf:var
            name="is-resource-provider"
            value="frp:findProvider($app, $form, 'form') = 'resource'"/>

        <xf:action if="not($is-resource-provider)">

            <xf:send submission="fb-read-form-metadata">
                <xf:property name="restrict-to-latest-version" value="event('restrict-to-latest-version')"/>
            </xf:send>

            <xf:action if="empty(instance('fr-versioning-form-metadata')/*)" type="xpath">
                frf:sendError(404)
            </xf:action>

            <xf:dispatch name="fr-versions-read" targetid="fr-versioning-model">
                <xf:property
                    name="versions"
                    value="
                        for $v in instance('fr-versioning-form-metadata')/form[not(available = 'false')]/form-version
                        return xs:integer($v)"/>
                <xf:property
                    name="latest-version"
                    value="instance('fr-versioning-form-metadata')/latest-version/data(.)"/>
                <xf:property
                    name="default-selected-version"
                    value="
                        if (not($versioning-supported-on-data-side)) then
                            (: No support on the data side so we always pass 1 as version :)
                            1
                        else if (count(instance('fr-versioning-form-metadata')/form/form-version) gt 1) then
                            (: Support on the data side and multiple possible versions so leave blank :)
                            ()
                        else
                            (: Support on the data side and only one possible version :)
                            xs:integer(instance('fr-versioning-form-metadata')/form/form-version)"/>
            </xf:dispatch>
        </xf:action>
        <xf:action if="$is-resource-provider">
            <!-- The `resource` provider doesn't implement the form metadata API, so just assume version 1. -->
            <xf:dispatch name="fr-versions-read" targetid="fr-versioning-model">
                <xf:property
                    name="versions"
                    value="1"/>
                <xf:property
                    name="latest-version"
                    value="1"/>
                <xf:property
                    name="default-selected-version"
                    value="1"/>
            </xf:dispatch>
        </xf:action>

    </xf:action>

    <xf:submission
        id="fb-read-form-metadata"
        method="get"
        serialization="none"
        resource="{frf:createFormMetadataPath($app, $form)}?all-versions={not(event('restrict-to-latest-version') = true())}"
        replace="instance"
        instance="fr-versioning-form-metadata">

        <xf:action event="xforms-submit-done">
            <xf:action
                context="instance('fr-versioning-form-metadata')"
                if="exists(form)">

                <xf:var name="i" value="."/>

                <!--
                    Persistence might not return any version information if it doesn' support versioning. So we
                    insert one version which defaults to "1".
                    NOTE: In this case, the API must return only one `<form>` element!
                -->
                <xf:insert
                    context="$i/form"
                    if="empty(form-version)"
                    ref="*"
                    origin="xf:element('form-version', 1)"/>

                <xf:setvalue
                    ref="instance('fr-versioning-instance')/latest-version"
                    value="
                        max(
                            $i//form/form-version[
                                . castable as xs:integer
                            ]/xs:integer(.)
                        )"/>
            </xf:action>

        </xf:action>

        <xf:message event="xforms-submit-error">An error occurred while reading form metadata.</xf:message>

    </xf:submission>

    <xf:instance id="fr-versioning-form-metadata">
        <dummy/>
    </xf:instance>

    <xf:instance id="fr-versioning-instance" xxf:expose-xpath-types="true">
        <publish>
            <latest-version>-1</latest-version> <!-- set by `fb-read-form-metadata` -->
        </publish>
    </xf:instance>

    <xf:bind ref="instance('fr-versioning-instance')">
        <xf:bind
            ref="latest-version"
            type="xs:integer"/>
    </xf:bind>

</xf:model>
